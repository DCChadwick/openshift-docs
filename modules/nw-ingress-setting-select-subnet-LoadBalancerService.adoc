// Modules included in the following assemblies:
//
// * ingress/configure-ingress-operator.adoc

:_mod-docs-content-type: PROCEDURE
[id="nw-ingress-setting-select-subnet-LoadBalancerService_{context}"]
= Choosing subnets while creating a LoadBalancerService ingress controller
You can manually specify load balancer subnets for Ingress Controllers in an existing cluster. By default, load balancer subnets are automatically discovered by AWS, but specifying them in the Ingress Controller  overrides this, allowing for manual control.

[NOTE]
====
This feature and procedure applies only to AWS. 
====

.Prerequisites
* You must have an installed AWS cluster.
* You must know the names or IDs of the subnets to which you intend to map your IngressController.

.Procedure
To create an Ingress Controller with manually specified load balancer subnets in {product-title} 4.17, you can follow these steps:

* Create a custom resource (CR) file.
** Create a YAML file (e.g., `sample-ingress.yaml`) with the following content:
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
    kind: IngressController
    metadata:
      namespace: openshift-ingress-operator
      name: <name>
    spec:
      domain: <domain>
      endpointPublishingStrategy:
        type: LoadBalancerService
        loadBalancer:
          scope: External
      dnsManagementPolicy: Managed
----

* Create a custom resource (CR) file.

** Create a YAML file (e.g., `sample-ingress.yaml`) with the following content:
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name:  <name> (1)
  namespace: openshift-ingress-operator
spec:
  domain: <domain> (2)
  endpointPublishingStrategy:
    type: LoadBalancerService
    loadBalancer:
      scope: External
      providerParameters:
        type: AWS
        aws:
          type: Classic
          classicLoadBalancer: (3)
              subnets:
                ids: (4)
                - <subnet> (5)
                - <subnet>
                - <subnet>
----+
Replace `<name>` with a name for the Ingress controller
<1> Replace `<name>` with a name for the Ingress Controller
<2> Replace `<domain>` with the DNS name serviced by the Ingress Controller
<3> You can also use the `networkLoadBalancer` field if using an NLB
<4> You can optionally specify subnet by name using the `names` field
<5> Specify subnet IDs (or names if you using `names`).
+
** Apply the CR file:

Save the file and apply it using the OpenShift CLI:
+
[source,terminal]
----
$  oc apply -f sample-ingress.yaml
+
** Confirm the load balancer was provisioned successfully by checking the IngressController conditions. 

    oc get ingresscontroller -n openshift-ingress-operator <name> -o jsonpath="{.status.conditions}" | yq -PC
+
----
+
= Updating the subnets on an existing Ingress Controller

* Choose the subnets.
----
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  name:  <name> (1)
  namespace: openshift-ingress-operator
spec:
  domain: <domain> (2)
  endpointPublishingStrategy:
    type: LoadBalancerService
    loadBalancer:
      scope: External
      providerParameters:
        type: AWS
        aws:
          type: Classic
          classicLoadBalancer: (3)
              subnets:
                ids: (4)
                - <updated-subnet> (5)
                - <updated-subnet>
                - <updated-subnet>
+
* Examine the `Progressing` condition on the IngressController for instructions on how to apply the subnet updates:
[source,terminal]
----
oc get ingresscontroller -n openshift-ingress-operator subnets -o jsonpath="{.status.conditions[?(@.type==\"Progressing\")]}" | yq -PC
lastTransitionTime: "2024-11-25T20:19:31Z"
message: 'One or more status conditions indicate progressing: LoadBalancerProgressing=True (OperandsProgressing: One or more managed resources are progressing: The IngressController subnets were changed from [...] to [...].  To effectuate this change, you must delete the service: `oc -n openshift-ingress delete svc/router-<name>`; the service load-balancer will then be deprovisioned and a new one created. This will most likely cause the new load-balancer to have a different host name and IP address and cause disruption. To return to the previous state, you can revert the change to the IngressController: [...]'
reason: IngressControllerProgressing
status: "True"
type: Progressing
----
+
* Delete the service associated with the IngressController to apply the update:

[source,terminal]
----
oc -n openshift-ingress delete svc/router-<name>
----

[WARNING]
====
An outage that can last several minutes due to new DNS records propagation, new load balancers provisioning, and other factors. IP addresses and canonical names of the Ingress Controller load balancer might change after applying this procedure.
====

* Confirm the load balancer was provisioned successfully by checking the IngressController conditions.

[source,terminal]
----  
oc get ingresscontroller -n openshift-ingress-operator <name> -o jsonpath="{.status.conditions}" | yq -PC
----